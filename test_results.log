
[94m================================================================================[0m
[94mContext-Aware SQL Generation - Comprehensive Test Suite[0m
[94m================================================================================[0m


[93m================================================================================[0m
[93mTest Set 1: LIMIT Refinement[0m
[93m================================================================================[0m

[92m‚úì PASS[0m Q1
  Q: [94mShow top 2 branches by total lending[0m
  Expected: LIMIT 2, aggregation on branches
  Got SQL: SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON b.id = l.branch_id GROUP BY...

[92m‚úì PASS[0m Q2
  Q: [94mmake it 5[0m
  Expected: Same structure, LIMIT changed to 5
  Got SQL: SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON b.id = l.branch_id GROUP BY...
  [93mNotes: Should preserve aggregation, only change LIMIT[0m

[91m‚úó FAIL[0m Q3
  Q: [94mmake it 10[0m
  Expected: Same structure, LIMIT changed to 10
  [91mNo SQL generated![0m

[93m================================================================================[0m
[93mTest Set 2: ORDER Refinement[0m
[93m================================================================================[0m

[92m‚úì PASS[0m Q1
  Q: [94mShow top 5 branches by total lending[0m
  Expected: LIMIT 5, ORDER BY DESC
  Got SQL: SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON b.id = l.branch_id GROUP BY...

[92m‚úì PASS[0m Q2
  Q: [94msort by branch_name asc[0m
  Expected: ORDER BY branch_name ASC, keep LIMIT 5
  Got SQL: SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON b.id = l.branch_id GROUP BY...

[92m‚úì PASS[0m Q3
  Q: [94msort by total_lending desc[0m
  Expected: ORDER BY total_lending DESC, keep LIMIT 5
  Got SQL: SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON b.id = l.branch_id GROUP BY...

[93m================================================================================[0m
[93mTest Set 3: Time Window Refinement[0m
[93m================================================================================[0m

[91m‚úó FAIL[0m Q1
  Q: [94mShow top 5 branches by total lending in June 2025[0m
  Expected: Filter for June 2025
  Got SQL: SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON b.id = l.branch_id AND EXTR...

[91m‚úó FAIL[0m Q2
  Q: [94mwhat about May 2025?[0m
  Expected: Same query, filter changed to May 2025
  Got SQL: SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON b.id = l.branch_id AND EXTR...
  [93mNotes: Should preserve structure, only change month[0m

[91m‚úó FAIL[0m Q3
  Q: [94mwhat about January 2025?[0m
  Expected: Same query, filter changed to January 2025
  Got SQL: SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON b.id = l.branch_id AND EXTR...

[93m================================================================================[0m
[93mTest Set 4: Metric Change (Keep Subject)[0m
[93m================================================================================[0m

[92m‚úì PASS[0m Q1
  Q: [94mShow top 5 branches by total lending[0m
  Expected: Branch aggregation, LIMIT 5
  Got SQL: SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON b.id = l.branch_id GROUP BY...

[91m‚úó FAIL[0m Q2
  Q: [94mnow by outstanding balance[0m
  Expected: Keep branches, change to outstanding_balance
  [91mNo SQL generated![0m
  [93mNotes: Should change SUM(principal) to SUM(outstanding_balance)[0m

[91m‚úó FAIL[0m Q3
  Q: [94mmake it 3[0m
  Expected: Keep metric, change LIMIT to 3
  Got SQL: SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON b.id = l.branch_id GROUP BY...

[93m================================================================================[0m
[93mTest Set 5: Pronoun Resolution ('those branches')[0m
[93m================================================================================[0m

[92m‚úì PASS[0m Q1
  Q: [94mShow top 3 branches by total lending[0m
  Expected: Top 3 branches
  Got SQL: SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON b.id = l.branch_id GROUP BY...

[92m‚úì PASS[0m Q2
  Q: [94mfor those branches, show total collections amount_collected[0m
  Expected: Use CTE/subquery to preserve top 3 branches, sum collections
  Got SQL: WITH previous_results AS (
  SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l O...
  [93mNotes: CRITICAL: Must preserve exact branch IDs from Q1[0m

[91m‚úó FAIL[0m Q3
  Q: [94mmake it 5[0m
  Expected: Change LIMIT to 5
  Got SQL: SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON b.id = l.branch_id GROUP BY...

[93m================================================================================[0m
[93mTest Set 6: Drill Down ('show details')[0m
[93m================================================================================[0m

[91m‚úó FAIL[0m Q1
  Q: [94mShow top 2 borrowers by total loan principal[0m
  Expected: Top 2 borrowers by principal
  [91mNo SQL generated![0m

[92m‚úì PASS[0m Q2
  Q: [94mshow details[0m
  Expected: Show borrower details (more columns)
  Got SQL: SELECT * FROM core.borrowers LIMIT 200
  [93mNotes: Should expand columns, keep borrower scope[0m

[92m‚úì PASS[0m Q3
  Q: [94monly include active loans[0m
  Expected: Add status filter to active
  Got SQL: SELECT * FROM core.borrowers WHERE id IN (SELECT borrower_id FROM core.loans WHERE status = 'active') LIMIT 200

[93m================================================================================[0m
[93mTest Set 7: Top Entity Reference[0m
[93m================================================================================[0m

[92m‚úì PASS[0m Q1
  Q: [94mShow top 5 branches by total lending[0m
  Expected: Top 5 branches
  Got SQL: SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON b.id = l.branch_id GROUP BY...

[92m‚úì PASS[0m Q2
  Q: [94min that top one, show all loans[0m
  Expected: Filter loans to #1 branch only
  Got SQL: WITH previous_results AS ( SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON ...
  [93mNotes: Should use CTE or subquery for top 1 branch[0m

[91m‚úó FAIL[0m Q3
  Q: [94mmake it 20[0m
  Expected: Change LIMIT to 20
  Got SQL: SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON b.id = l.branch_id GROUP BY...

[93m================================================================================[0m
[93mTest Set 8: Cross-Table Continuation[0m
[93m================================================================================[0m

[92m‚úì PASS[0m Q1
  Q: [94mShow top 1 branch by total collections[0m
  Expected: Top 1 branch by collections
  Got SQL: SELECT b.branch_name, COALESCE(SUM(c.amount_collected), 0) AS total_collections FROM core.branches b LEFT JOIN core.collections c ON b.id = c.field_of...

[92m‚úì PASS[0m Q2
  Q: [94min that branch, show top 5 field officers by amount_collected[0m
  Expected: Officers in that branch, LIMIT 5
  Got SQL: SELECT t2.full_name, COALESCE(SUM(t1.amount_collected), 0) AS total_collected FROM core.loans t1 LEFT JOIN core.collections t2 ON t1.id = t2.loan_id A...
  [93mNotes: Should preserve branch scope[0m

[91m‚úó FAIL[0m Q3
  Q: [94mwhat about last 30 days?[0m
  Expected: Add time filter for 30 days
  [91mNo SQL generated![0m

[93m================================================================================[0m
[93mTest Set 9: Borrower Scope Continuation[0m
[93m================================================================================[0m

[92m‚úì PASS[0m Q1
  Q: [94mShow top 3 borrowers by total repayments amount[0m
  Expected: Top 3 borrowers by repayments
  Got SQL: SELECT b.full_name, COALESCE(SUM(r.amount), 0) AS total_repayments FROM core.borrowers b LEFT JOIN core.loans l ON b.id = l.borrower_id LEFT JOIN core...

[92m‚úì PASS[0m Q2
  Q: [94mfor those borrowers, show their loans with outstanding_balance[0m
  Expected: Loans for those 3 borrowers
  Got SQL: SELECT b.full_name, l.loan_number, l.outstanding_balance FROM core.borrowers AS b LEFT JOIN core.loans AS l ON b.id = l.borrower_id LIMIT 200
  [93mNotes: Should preserve borrower subset with CTE/subquery[0m

[92m‚úì PASS[0m Q3
  Q: [94msort by outstanding_balance desc[0m
  Expected: Add ORDER BY outstanding_balance DESC
  Got SQL: SELECT b.full_name, l.loan_number, l.outstanding_balance FROM core.borrowers AS b LEFT JOIN core.loans AS l ON b.id = l.borrower_id ORDER BY l.outstan...

[93m================================================================================[0m
[93mTest Set 10: Unrelated Query (Context Reset)[0m
[93m================================================================================[0m

[92m‚úì PASS[0m Q1
  Q: [94mShow top 5 branches by total lending[0m
  Expected: Top 5 branches
  Got SQL: SELECT b.branch_name, COALESCE(SUM(l.principal_amount), 0) AS total_lending FROM core.branches b LEFT JOIN core.loans l ON b.id = l.branch_id GROUP BY...

[92m‚úì PASS[0m Q2
  Q: [94mList all borrowers[0m
  Expected: All borrowers (ignore branch context)
  Got SQL: SELECT b.borrower_code, b.full_name, b.phone, b.address FROM core.borrowers AS b LIMIT 200
  [93mNotes: CRITICAL: Should NOT use context from Q1[0m

[94m================================================================================[0m
[94mTEST SUMMARY[0m
[94m================================================================================[0m

[91m‚úó FAIL[0m Test Set 1 (LIMIT refinement)
[92m‚úì PASS[0m Test Set 2 (ORDER refinement)
[91m‚úó FAIL[0m Test Set 3 (Time window)
[91m‚úó FAIL[0m Test Set 4 (Metric change)
[91m‚úó FAIL[0m Test Set 5 (Pronoun resolution)
[91m‚úó FAIL[0m Test Set 6 (Drill down)
[91m‚úó FAIL[0m Test Set 7 (Top entity reference)
[91m‚úó FAIL[0m Test Set 8 (Cross-table)
[92m‚úì PASS[0m Test Set 9 (Borrower scope)
[92m‚úì PASS[0m Test Set 10 (Unrelated reset)

[94mOverall: 3/10 test sets passed[0m
[93m
‚ö†Ô∏è  Some tests failed. Review the output above for details.[0m

